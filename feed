#!/usr/bin/env ruby
Encoding.default_external = Encoding::UTF_8
require 'feedjira'
source = `ls ~/.rss_reader | grep urls | cut -d "-" -f 1 | dmenu -p "Source: " -i -l 20`.chomp
while source != ""
  if source == "youtube"
    application = "mpv"
  elsif source == "news"
    application = "surf"
  end
  
  url = `(echo "BACK" && cat ~/.rss_reader/#{source}-urls) | dmenu -i -l 20 | cut -d "|" -f 2 | cut -d " " -f 2`.chomp
  if url == ""
    break
  elsif url == "BACK"
    system "exec ~/scripts/content/rss"
    break
  elsif url != ""
    feed = Feedjira::Feed.fetch_and_parse url
    entries = []
    feed.entries.each do |entry|
      entries.push(entry)
    end
    entry_titles = []
    entries.each do |entry|
      entry_titles.push(entry.title.gsub(/"/, "'"))
    end

    selected = `(echo "BACK" && echo "#{entry_titles.join("\n")}") | dmenu -i -l 30`.chomp
    
    if selected != "" && selected != "BACK"
      position = entry_titles.index(selected)
      system "#{application} #{entries[position].url}"
    end
    unless selected == "BACK"
      break
    end
  end
end
